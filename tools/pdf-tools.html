<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Tools - Digital Utility</title>
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Grotesk:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="../assets/js/lucide.min.js"></script>
    <script src="../assets/js/app.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link rel="stylesheet" href="../assets/css/global.css">



    <link rel="stylesheet" href="../assets/css/tools.css">
    <style>
        @media (max-width: 768px) {
            .tools-container {
                padding: 1rem;
            }

            .category-tabs {
                flex-direction: column;
            }

            .input-group {
                flex-direction: column;
            }

            .tool-input,
            .tool-btn {
                width: 100%;
            }

            .tool-btn {
                margin-top: 0.5rem;
            }
        }
    </style>
    <!-- Theme Data Script (Anti-Flicker) -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem("theme");
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>

<body class="tools-page" data-theme="dark">
    <div style="padding: 1.5rem;">
        <a href="../tools.html" class="tool-btn"
            style="background:transparent; border:1px solid currentColor; color:inherit;">
            <i data-lucide="arrow-left" style="height:1em; vertical-align:middle;"></i> Back to Tools
        </a>
    </div>

    <div class="tools-container" style="max-width: 50rem;">
        <header class="tools-header" style="margin-top:2rem;">
            <h1 class="tools-title">PDF Forensics & Utils</h1>
            <p class="tools-subtitle">Analyze metadata, uncover authors, and manage PDF files entirely client-side.</p>
        </header>

        <div class="tool-card">
            <div class="category-tabs"
                style="display:flex; gap:0.5rem; margin-bottom:1.5rem; border-bottom:1px solid #333; padding-bottom:0.5rem;">
                <button class="tab-btn active" onclick="switchTab('forensics')"
                    style="background:var(--tool-accent); color:#000; border:none; padding:0.5rem 1rem; border-radius:6px; cursor:pointer; font-weight:600;">
                    Metadata Forensics
                </button>
                <button class="tab-btn" onclick="switchTab('utilities')"
                    style="background:transparent; color:#888; border:none; padding:0.5rem 1rem; border-radius:6px; cursor:pointer; font-weight:600;">
                    Utilities (Merge)
                </button>
            </div>

            <!-- FORENSICS TAB -->
            <div id="forensics" class="tool-section active">
                <div class="input-group">
                    <input type="file" id="forensicsInput" class="tool-input" accept="application/pdf">
                    <button id="scanBtn" class="tool-btn">Scan Metadata</button>
                </div>
                <p style="font-size:0.8rem; color:#6b7280; margin-top:0.5rem;">
                    Upload a PDF to reveal hidden author info, software used, and creation dates.
                </p>
                <div id="forensicsResult" class="result-box"></div>
            </div>

            <!-- UTILITIES TAB -->
            <div id="utilities" class="tool-section" style="display:none;">
                <h3 style="font-size:1rem; margin-bottom:1rem;">Merge PDFs</h3>
                <div class="input-group">
                    <input type="file" id="mergeInput" class="tool-input" accept="application/pdf" multiple>
                    <button id="mergeBtn" class="tool-btn">Merge & Download</button>
                </div>
                <p style="font-size:0.8rem; color:#6b7280; margin-top:0.5rem;">Select 2+ PDF files to combine them into
                    one.</p>
                <div id="mergeResult" class="result-box"></div>
            </div>
        </div>
    </div>


    <!-- PDF.js for Forensics -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
    <!-- PDF-Lib for Utilities -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <script>
        lucide.createIcons();

        function switchTab(tabId) {
            document.querySelectorAll('.tool-section').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = '#888';
                btn.classList.remove('active');
            });

            document.getElementById(tabId).style.display = 'block';

            // Highlight active tab
            const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.textContent.toLowerCase().includes(tabId === 'utilities' ? 'merge' : 'forensics'));
            if (activeBtn) {
                activeBtn.style.background = 'var(--tool-accent)';
                activeBtn.style.color = '#000';
            }
        }

        // --- FORENSICS LOGIC ---
        document.getElementById('scanBtn').addEventListener('click', async () => {
            const file = document.getElementById('forensicsInput').files[0];
            const resBox = document.getElementById('forensicsResult');
            if (!file) { alert("Please select a PDF first."); return; }

            resBox.innerHTML = "Scanning PDF structure...";
            resBox.classList.add('visible');

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                const metadata = await pdf.getMetadata();

                const info = metadata.info || {};

                // Helper for dates
                const formatDate = (dStr) => {
                    if (!dStr) return "Unknown";
                    // PDF date format: D:YYYYMMDDHHmmSS...
                    // Simple parser or just display raw if complex
                    return dStr.replace("D:", "").replace("'", "").replace("'", "");
                };

                // Risk Analysis
                const author = info.Author || "Unknown";
                const creator = info.Creator || "Unknown"; // Software
                const producer = info.Producer || "Unknown"; // Conversion engine

                let riskHtml = '';
                if (author !== "Unknown" && creator.toLowerCase().includes("word")) {
                    riskHtml = `<div style="color:var(--status-warn); margin-bottom:1rem; font-size:0.9rem;">âš ï¸ <strong>Insight:</strong> Created in Word by "${author}". Mismatch with sender name?</div>`;
                }

                let html = `
                    <div style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:8px; border:1px solid rgba(255,255,255,0.1);">
                        ${riskHtml}
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                            <!-- Author Info -->
                            <div>
                                <div style="color:#888; font-size:0.85rem;">Author / User</div>
                                <div style="font-weight:bold; color:#fff;">${author}</div>
                            </div>
                             <div>
                                <div style="color:#888; font-size:0.85rem;">Software (Creator)</div>
                                <div style="font-weight:bold; color:var(--tool-accent);">${creator}</div>
                            </div>
                             <div>
                                <div style="color:#888; font-size:0.85rem;">PDF Producer</div>
                                <div style="font-family:monospace; font-size:0.85rem;">${producer}</div>
                            </div>
                             <div>
                                <div style="color:#888; font-size:0.85rem;">Page Count</div>
                                <div style="font-weight:bold;">${pdf.numPages}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top:1rem; border-top:1px solid #333; padding-top:1rem; display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                             <div>
                                <div style="color:#888; font-size:0.85rem;">Created</div>
                                <div style="color:#ddd; font-size:0.9rem;">${formatDate(info.CreationDate)}</div>
                            </div>
                             <div>
                                <div style="color:#888; font-size:0.85rem;">Modified</div>
                                <div style="color:#ddd; font-size:0.9rem;">${formatDate(info.ModDate)}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Raw Data Toggle
                html += `
                    <div style="margin-top:1.5rem;">
                         <button onclick="this.nextElementSibling.style.display='block'; this.style.display='none';" 
                            style="background:transparent; color:#888; border:1px solid #444; padding:0.4rem 1rem; border-radius:4px; cursor:pointer; font-size:0.8rem;">
                            View Raw Metadata JSON
                        </button>
                        <pre style="display:none; background:#111; padding:1rem; border-radius:6px; overflow-x:auto; font-size:0.8rem; color:#4ade80;">${JSON.stringify(info, null, 2)}</pre>
                    </div>
                `;

                resBox.innerHTML = html;

            } catch (e) {
                console.error(e);
                resBox.innerText = "Error reading PDF metadata. Is it encrypted?";
            }
        });

        // --- MERGE LOGIC (Existing) ---
        document.getElementById('mergeBtn').addEventListener('click', async () => {
            const input = document.getElementById('mergeInput');
            const resultsArea = document.getElementById('mergeResult');

            if (input.files.length < 2) {
                alert("Please select at least 2 PDF files to merge.");
                return;
            }

            resultsArea.innerText = "Processing... (This runs entirely in your browser)";
            resultsArea.classList.add('visible');

            try {
                const { PDFDocument } = PDFLib;
                const mergedPdf = await PDFDocument.create();

                for (let file of input.files) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                    copiedPages.forEach((page) => mergedPdf.addPage(page));
                }

                const pdfBytes = await mergedPdf.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const url = URL.createObjectURL(blob);

                resultsArea.innerHTML = `
                    <div style="color:var(--status-success); font-weight:bold;">Merge Complete!</div>
                    <a href="${url}" download="merged_document.pdf" class="tool-btn" style="display:inline-block; margin-top:1rem; text-decoration:none;">Download Merged PDF</a>
                `;

            } catch (e) {
                resultsArea.innerText = "Error processing PDFs. Ensure files are valid.";
                console.error(e);
            }
        });
    </script>

    <!-- Hover Footer -->
    <!-- Hover Footer -->

</body>

</html>