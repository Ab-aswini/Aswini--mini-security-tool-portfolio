<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASN Threat Intelligence - Archive</title>
    <link rel="icon" type="image/png" href="../assets/images/favicon.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Space+Grotesk:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="../assets/js/lucide.min.js"></script>
    <link rel="stylesheet" href="../assets/css/global.css">
    <link rel="stylesheet" href="../assets/css/tools.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        body {
            background: #09090b;
            color: #e4e4e7;
            font-family: 'Inter', sans-serif;
        }

        .tool-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .tool-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .tool-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .search-box {
            display: flex;
            gap: 0.5rem;
            max-width: 600px;
            margin: 0 auto 2.5rem;
        }

        .url-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #3f3f46;
            color: #fff;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1rem;
        }

        .scan-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0 2rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scan-btn:hover {
            background: #2563eb;
        }

        /* Command Center Grid */
        .intel-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            display: none;
            /* Hidden by default */
            animation: fadeIn 0.5s ease;
        }

        @media (max-width: 900px) {
            .intel-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Card Styles */
        .intel-card {
            background: #111;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #27272a;
            padding-bottom: 0.75rem;
            color: #94a3b8;
            font-family: 'Space Grotesk', sans-serif;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        /* Map Container */
        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            z-index: 1;
        }

        /* Data Key-Value Pairs */
        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .data-label {
            color: #71717a;
        }

        .data-val {
            color: #e4e4e7;
            font-family: monospace;
            text-align: right;
        }

        .data-val.accent {
            color: #60a5fa;
            font-weight: bold;
        }

        .data-val.warn {
            color: #f59e0b;
        }

        /* BGP Prefix Table */
        .bgp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            font-family: monospace;
        }

        .bgp-table th {
            text-align: left;
            color: #71717a;
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
        }

        .bgp-table td {
            padding: 0.5rem 0;
            border-bottom: 1px solid #222;
            color: #a1a1aa;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .loading-overlay {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #71717a;
            font-family: monospace;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <!-- Theme Script -->
    <style>
        @media (max-width: 768px) {
            .tool-container {
                padding: 1rem;
            }

            .tool-title {
                font-size: 1.75rem;
            }

            .search-box {
                flex-direction: column;
                width: 100%;
            }

            .url-input,
            .scan-btn {
                width: 100%;
            }
        }
    </style>
    <script>
        (function () {
            const savedTheme = localStorage.getItem("theme");
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (systemPrefersDark ? "dark" : "light");
            document.documentElement.setAttribute("data-theme", theme);
        })();
    </script>
</head>

<body>
    <div class="tool-container">
        <div class="top-nav">
            <a href="../tools/lab-architecture.html" class="tool-btn" style="color:#a1a1aa; text-decoration:none;">
                <i data-lucide="arrow-left" style="height:1em;"></i> Back to Archives
            </a>
        </div>

        <div class="tool-header">
            <h1 class="tool-title">ASN Intelligence Scanner</h1>
            <p style="color:#a1a1aa;">Military-grade network reconnaissance & BGP routing intel.</p>
        </div>

        <div class="search-box">
            <input type="text" id="targetInput" class="url-input"
                placeholder="Enter IP (8.8.8.8) or Domain (google.com)">
            <button class="icon-btn" id="myIpBtn" onclick="useMyIp()" title="Use My Current IP"
                style="margin-right:0.5rem; background:transparent; border:1px solid #333; color:#a1a1aa; border-radius:8px; cursor:pointer; padding:0 1rem;">
                <i data-lucide="map-pin"></i>
            </button>
            <button class="scan-btn" id="scanBtn" onclick="startRecon()">INITIATE</button>
        </div>

        <div id="loading" class="loading-overlay">
            <i data-lucide="radar" class="spin" style="margin-bottom:0.5rem;"></i><br>
            Triangulating Target...
        </div>

        <div class="intel-grid" id="dashboard">
            <!-- Left Col: Map & Primary Info -->
            <div style="display:flex; flex-direction:column; gap:1.5rem;">
                <div class="intel-card" style="padding:0; height:400px;">
                    <div id="map"></div>
                </div>

                <div class="intel-card">
                    <div class="card-header">
                        <i data-lucide="server" style="width:16px;"></i> &nbsp;TARGET IDENTITY
                    </div>
                    <div class="data-row">
                        <span class="data-label">IP Address</span>
                        <span class="data-val accent" id="ipDisp">--</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Hostname</span>
                        <span class="data-val" id="hostDisp">--</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Organization</span>
                        <span class="data-val" id="orgDisp">--</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">ASN (Autonomous System)</span>
                        <span class="data-val accent" id="asnDisp">--</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Datacenter Location</span>
                        <span class="data-val" id="locDisp">--</span>
                    </div>
                    <div class="data-row" style="margin-bottom:0;">
                        <span class="data-label">Timezone</span>
                        <span class="data-val" id="tzDisp">--</span>
                    </div>
                </div>
            </div>

            <!-- Right Col: BGP & Abuse Intel -->
            <div style="display:flex; flex-direction:column; gap:1.5rem;">

                <div class="intel-card">
                    <div class="card-header">
                        <i data-lucide="shield-alert" style="width:16px;"></i> &nbsp;THREAT INTEL
                    </div>
                    <div class="data-row">
                        <span class="data-label">Network Type</span>
                        <span class="status-badge" id="netTypeDisp">--</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">RIR Registry</span>
                        <span class="data-val" id="rirDisp">--</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Abuse Contact</span>
                        <span class="data-val warn" id="abuseDisp">--</span>
                    </div>
                </div>

                <div class="intel-card" style="flex:1;">
                    <div class="card-header">
                        <i data-lucide="network" style="width:16px;"></i> &nbsp;BGP PREFIXES (RIPEstat)
                    </div>
                    <div style="max-height:300px; overflow-y:auto;">
                        <table class="bgp-table">
                            <thead>
                                <tr>
                                    <th>Prefix</th>
                                    <th>Registry</th>
                                </tr>
                            </thead>
                            <tbody id="bgpBody">
                                <!-- Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>


    <script src="../assets/js/app.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        lucide.createIcons();
        let map;
        let marker;

        async function useMyIp() {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                if (!res.ok) throw new Error("IP API Failed");
                const data = await res.json();
                document.getElementById('targetInput').value = data.ip;
                startRecon();
            } catch (e) {
                // UI Error Display instead of alert
                const errDiv = document.createElement('div');
                errDiv.style.color = '#ef4444';
                errDiv.style.textAlign = 'center';
                errDiv.style.marginTop = '1rem';
                errDiv.innerHTML = `<strong>Error:</strong> Could not detect IP. <br><span style="font-size:0.8em; opacity:0.8">${e.message}</span>`;
                document.querySelector('.search-box').appendChild(errDiv);
                setTimeout(() => errDiv.remove(), 5000);
            }
        }

        async function startRecon() {
            const input = document.getElementById('targetInput').value.trim();
            if (!input) return;

            // UI Reset
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loading').style.display = 'block';

            try {
                // 1. Resolve Input (If domain, getting IP is tricky client-side without DNS API)
                // We'll trust ipapi.co to handle basic resolution or user inputs IP directly.
                // For better domain support, we'd use 'https://dns.google/resolve?name='+input

                let targetIp = input;
                const isIp = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(input);

                if (!isIp) {
                    // Try basic DNS resolution via Google DNS API
                    const dnsRes = await fetch(`https://dns.google/resolve?name=${input}&type=A`);
                    const dnsData = await dnsRes.json();
                    if (dnsData.Answer && dnsData.Answer.length > 0) {
                        targetIp = dnsData.Answer[dnsData.Answer.length - 1].data; // Take last A record
                    }
                }

                // 2. Primary Recon (IPAPI)
                const ipRes = await fetch(`https://ipapi.co/${targetIp}/json/`);
                if (!ipRes.ok) throw new Error(`IP Lookup Failed (${ipRes.status})`);
                const ipData = await ipRes.json();

                if (ipData.error) throw new Error(ipData.reason || "IP Lookup Failed");

                // Render Primary Data
                document.getElementById('ipDisp').innerText = ipData.ip;
                document.getElementById('hostDisp').innerText = input; // Best guess
                document.getElementById('orgDisp').innerText = ipData.org || ipData.asn_org || 'N/A';
                document.getElementById('asnDisp').innerText = ipData.asn || 'N/A';
                document.getElementById('locDisp').innerText = `${ipData.city}, ${ipData.region}, ${ipData.country_name}`;
                document.getElementById('tzDisp').innerText = ipData.timezone || 'UTC';
                document.getElementById('netTypeDisp').innerText = "Hosting/Business"; // Placeholder heuristic
                document.getElementById('rirDisp').innerText = "ARIN/RIPE"; // Placeholder until RIPEstat

                // 3. Render Map
                if (!map) {
                    map = L.map('map').setView([ipData.latitude, ipData.longitude], 13);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; OpenStreetMap &copy; CARTO'
                    }).addTo(map);
                } else {
                    map.setView([ipData.latitude, ipData.longitude], 13);
                }

                if (marker) map.removeLayer(marker);
                marker = L.marker([ipData.latitude, ipData.longitude]).addTo(map)
                    .bindPopup(`<b>${ipData.ip}</b><br>${ipData.city}, ${ipData.country_code}`).openPopup();


                // 4. Deep Intel (RIPEstat)
                // Get announced prefixes for this IP
                // API: https://stat.ripe.net/data/network-info/data.json?resource=IP
                const ripeRes = await fetch(`https://stat.ripe.net/data/network-info/data.json?resource=${ipData.ip}`);
                if (!ripeRes.ok) throw new Error("RIPEstat API Failed");
                const ripeData = await ripeRes.json();

                if (ripeData.data && ripeData.data.prefix) {
                    const prefix = ripeData.data.prefix;
                    const desc = ripeData.data.asns[0] || ipData.asn;

                    const tbody = document.getElementById('bgpBody');
                    tbody.innerHTML = `
                        <tr>
                            <td style="color:#60a5fa; font-weight:bold;">${prefix}</td>
                            <td>${desc}</td>
                        </tr>
                    `;

                    // Abuse Contact (from Extra RIPE call or IPAPI fallback)
                    // Trying a second RIPE call for Abuse Contact if possible, else use IPAPI fallback (which is null usually)
                    // Abuse contact often requires parsed WHOIS which ipapi sometimes has, or RIPE `abuse-contact-finder`
                    fetch(`https://stat.ripe.net/data/abuse-contact-finder/data.json?resource=${prefix}`)
                        .then(r => r.json())
                        .then(d => {
                            if (d.data && d.data.abuse_contacts && d.data.abuse_contacts.length > 0) {
                                document.getElementById('abuseDisp').innerText = d.data.abuse_contacts[0];
                            } else {
                                document.getElementById('abuseDisp').innerText = "Not Publicly Listed";
                            }
                        });
                }

                // Show Dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'grid';

                // Trigger resize for Leaflet after display block
                setTimeout(() => { map.invalidateSize(); }, 100);

            } catch (e) {
                // UI Error Display
                document.getElementById('loading').style.display = 'none';
                const dashboard = document.getElementById('dashboard');
                dashboard.style.display = 'block'; // Show dashboard to insert error, or better use a separate error container

                // We'll replace the dashboard content with an error message temporarily or inject it on top
                const container = document.querySelector('.tool-container');
                const errBox = document.createElement('div');
                errBox.className = 'intel-card';
                errBox.style.borderColor = '#ef4444';
                errBox.style.color = '#ef4444';
                errBox.style.textAlign = 'center';
                errBox.style.marginBottom = '2rem';
                errBox.innerHTML = `<i data-lucide="alert-triangle" style="margin-bottom:0.5rem"></i><br><strong>Scan Error</strong><br>${e.message}`;

                // Insert after header
                const header = document.querySelector('.tool-header');
                header.parentNode.insertBefore(errBox, header.nextSibling);
                lucide.createIcons();
            }
        }

        document.getElementById('targetInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startRecon();
        });
    </script>
</body>

</html>